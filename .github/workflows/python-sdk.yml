---
# yamllint disable rule:truthy
name: "Python SDK"
on:
  pull_request:
    paths:
      - ".github/**"
      - "backend/**"
      - "python_sdk/**"
      - pyproject.toml
      - poetry.lock
      - "tasks/**"
  push:
    branches:
      - develop
      - stable

env:
  NEO4J_USERNAME: neo4j
  NEO4J_PASSWORD: admin
  NEO4J_ADDRESS: localhost
  NEO4J_PORT: 7687
  NEO4J_PROTOCOL: neo4j

jobs:
  python-tests:
    runs-on: "ubuntu-20.04"
    steps:
      - name: "Check out repository code"
        uses: "actions/checkout@v3"
      - name: "Setup Python environment"
        run: "pip install poetry==1.3.2 toml invoke"
      - name: "Setup Git"
        run: |
          git config --global --add safe.directory '*'
          git config --global user.email "infrahub@example.com"
          git config --global user.name "Infrahub"
      - name: "Setup Docker-Compose"
        run: cp development/docker-compose.override.yml.tmp development/docker-compose.override.yml
      - name: "Start database"
        run: "invoke demo.dev-start"
      - name: "Install project"
        run: "poetry install --only=main,dev,sdk,server"
      - name: "Black Tests"
        run: "poetry run invoke sdk.black"
      - name: "Isort Tests"
        run: "poetry run invoke sdk.isort"
      - name: "Flake8 Tests"
        run: "poetry run invoke sdk.flake8"
      - name: "Pylint Tests"
        run: "poetry run invoke sdk.pylint"
      - name: "Mypy Tests"
        run: "poetry run invoke sdk.mypy"
      - name: "Await healthy containers"
        run: "poetry run invoke demo.wait-healthy"
      - name: "Unit Tests"
        run: "poetry run pytest --cov=infrahub_client python_sdk/tests/unit"
      - name: "Coveralls : Unit Tests"
        uses: coverallsapp/github-action@v2.0.0
        env:
          COVERALLS_SERVICE_NUMBER: ${{ github.sha }}
        with:
          flag-name: python-sdk-unit
          parallel: true
      - name: "Integration Tests"
        run: "poetry run pytest --cov=infrahub_client python_sdk/tests/integration"
      - name: "Coveralls : Integration Tests"
        uses: coverallsapp/github-action@v2.0.0
        env:
          COVERALLS_SERVICE_NUMBER: ${{ github.sha }}
        with:
          flag-name: python-sdk-integration
          parallel: true
