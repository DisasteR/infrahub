---
version: "3.4"
services:
  infrahub-server:
    build:
      context: ../
      dockerfile: development/Dockerfile-backend
    image: "opsmill/infrahub-backend-py${PYTHON_VER}:${IMAGE_VER}"
    command: gunicorn infrahub.api.main:app --workers 4 --worker-class uvicorn.workers.UvicornWorker --bind 0.0.0.0:8000
    ports:
      - "8000:8000"
    depends_on:
      database:
        condition: service_healthy
      message-queue:
        condition: service_healthy
    environment:
      - "INFRAHUB_CONFIG=/source/development/infrahub.toml"
    volumes:
      - ../:/source
    tty: true
  infrahub-git:
    build:
      context: ../
      dockerfile: development/Dockerfile-backend
    image: "opsmill/infrahub-backend-py${PYTHON_VER}:${IMAGE_VER}"
    command: infrahub git-agent start --debug
    depends_on:
      - infrahub-server
    environment:
      - "INFRAHUB_CONFIG=/source/development/infrahub.toml"
      - "INFRAHUB_ADDRESS=http://infrahub-server:8000"
    volumes:
      - ../:/source
      - "git_data:/opt/infrahub/git"
    tty: true
  frontend:
    build:
      context: ../
      dockerfile: development/Dockerfile-frontend
    image: "opsmill/infrahub-frontend:${IMAGE_VER}"
    command: npx serve -s build
    depends_on:
      - infrahub-server
    ports:
      - "3000:3000"
    tty: true
volumes:
  git_data:
