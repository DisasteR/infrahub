---
# yamllint disable rule:line-length

version: "3.4"
services:
  infrahub-server:
    build:
      context: ../
      dockerfile: development/Dockerfile-backend
    image: "${IMAGE_NAME_BACKEND}:${IMAGE_VER}"
    command: >
      gunicorn --config backend/infrahub/serve/gunicorn_config.py --logger-class infrahub.serve.log.GunicornLogger infrahub.api.main:app
    depends_on:
      database:
        condition: service_healthy
      message-queue:
        condition: service_healthy
    environment:
      - "INFRAHUB_CONFIG=/source/development/infrahub.toml"
      - "INFRAHUB_PRODUCTION=false"
      - "INFRAHUB_LOG_LEVEL=INFO"
      - "INFRAHUB_SECURITY_INITIAL_ADMIN_TOKEN=06438eb2-8019-4776-878c-0941b1f1d1ec"
      - "INFRAHUB_SECURITY_SECRET_KEY=327f747f-efac-42be-9e73-999f08f86b92"
      - "INFRAHUB_EXPERIMENTAL_IGNORE_AUTHENTICATION_REQUIREMENTS=false"
      - "INFRAHUB_ALLOW_ANONYMOUS_ACCESS=true"
      - "PROMETHEUS_MULTIPROC_DIR=/prom_shared"
    volumes:
      - ../:/source
    tty: true
    healthcheck:
      test: wget -O /dev/null http://localhost:8000/schema || exit 1
      interval: 2s
      timeout: 5s
      retries: 20
      start_period: 3s
  infrahub-git:
    build:
      context: ../
      dockerfile: development/Dockerfile-backend
    image: "${IMAGE_NAME_BACKEND}:${IMAGE_VER}"
    command: infrahub git-agent start --debug
    restart: unless-stopped
    depends_on:
      - infrahub-server
    environment:
      - "INFRAHUB_CONFIG=/source/development/infrahub.toml"
      - "INFRAHUB_ADDRESS=http://infrahub-server:8000"
      - "INFRAHUB_PRODUCTION=false"
      - "INFRAHUB_LOG_LEVEL=DEBUG"
      - "INFRAHUB_SDK_API_TOKEN=06438eb2-8019-4776-878c-0941b1f1d1ec"
    volumes:
      - ../:/source
      - "git_data:/opt/infrahub/git"
    tty: true
  frontend:
    build:
      context: ../
      dockerfile: development/Dockerfile-frontend
    image: "${IMAGE_NAME_FRONTEND}:${IMAGE_VER}"
    command: >
      bash -c "npm i --omit=dev && npm run build-serve"
    depends_on:
      infrahub-server:
        condition: service_healthy
    volumes:
      - ../frontend/:/source
      - /source/node_modules/
    tty: true
volumes:
  git_data:
